name: build-rhel9-images

on:
  workflow_dispatch:
  workflow_call:
  push:
    branches:
      - main
      - release/*
      - runner_test
    paths:
      - .ci/docker/rhel9/**
      - .github/workflows/build-rhel9-images.yml
    tags:
      # Release candidate tags
      - v[0-9]+.[0-9]+.0+-rc[0-9]+
  pull_request:
    paths:
      - .ci/docker/rhel9/**
      - .github/workflows/build-rhel9-images.yml

permissions: read-all

jobs:
  build-rhel9-images:
    runs-on: test-runner-git-109-vpc
    timeout-minutes: 240
    strategy:
      fail-fast: false
      matrix:
        tag: ["cuda12.8"]
    steps:
      - name: Checkout PyTorch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clean up stale podman containers and configure storage
        shell: bash
        run: |
          # Reset podman storage to clean state
          podman system reset -f || true

          # Create podman config directory
          mkdir -p ~/.config/containers

          # Get actual home directory path
          ACTUAL_HOME=$(eval echo ~)

          # Configure podman to use home directory for storage
          cat > ~/.config/containers/storage.conf << EOF
          [storage]
          driver = "overlay"
          runroot = "${ACTUAL_HOME}/.local/share/containers/storage"
          graphroot = "${ACTUAL_HOME}/.local/share/containers/storage"

          [storage.options]
          additionalimagestores = []
          pull_options = {enable_partial_images = "false", use_hard_links = "false", ostree_repos=""}

          [storage.options.overlay]
          mountopt = "nodev,metacopy=on"
          EOF
          # Create storage and temp directories
          mkdir -p ~/.local/share/containers/storage
          mkdir -p ~/tmp
          # Set TMPDIR to use home directory
          echo "TMPDIR=$HOME/tmp" >> $GITHUB_ENV

      - name: Build and tag RHEL 9 Docker image
        shell: bash
        run: |
          cd .ci/docker/rhel9
          # Build script creates image with temp tag, we need to find it and tag properly
          BEFORE_IMAGES=$(docker images --format '{{.Repository}}:{{.Tag}}' | sort)
          ./build.sh rhel9-builder:${{ matrix.tag }}
          AFTER_IMAGES=$(docker images --format '{{.Repository}}:{{.Tag}}' | sort)
          # Find the newly created image (the temp tag)
          NEW_IMAGE=$(comm -13 <(echo "$BEFORE_IMAGES") <(echo "$AFTER_IMAGES") | grep -v '<none>' | head -1)
          echo "New image created: $NEW_IMAGE"
          # Tag it with the expected names
          docker tag "$NEW_IMAGE" rhel9-builder:${{ matrix.tag }}
          docker tag "$NEW_IMAGE" ci-image:pytorch-rhel-9.6-py3.12-gcc11-${{ matrix.tag }}
          # Also tag without CUDA version suffix for nightly workflow compatibility
          docker tag "$NEW_IMAGE" ci-image:pytorch-rhel-9.6-py3.12-gcc11

      - name: Verify CUDA installation
        if: matrix.tag != 'cpu'
        run: |
          CUDA_VERSION=$(echo "${{ matrix.tag }}" | sed 's/cuda//')
          docker run --rm ci-image:pytorch-rhel-9.6-py3.12-gcc11-${{ matrix.tag }} nvcc --version | grep "release ${CUDA_VERSION}"

      - name: Verify Python version
        run: |
          docker run --rm ci-image:pytorch-rhel-9.6-py3.12-gcc11-${{ matrix.tag }} python --version
          docker run --rm ci-image:pytorch-rhel-9.6-py3.12-gcc11-${{ matrix.tag }} python3.12 --version | grep "Python 3.12"

      - name: Test basic build tools
        run: |
          docker run --rm ci-image:pytorch-rhel-9.6-py3.12-gcc11-${{ matrix.tag }} bash -c "gcc --version && g++ --version && cmake --version"
