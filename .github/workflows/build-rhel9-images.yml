name: build-rhel9-images

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - release/*
      - runner_test
    paths:
      - .ci/docker/rhel9/**
      - .github/workflows/build-rhel9-images.yml
    tags:
      # Release candidate tags
      - v[0-9]+.[0-9]+.0+-rc[0-9]+
  pull_request:
    paths:
      - .ci/docker/rhel9/**
      - .github/workflows/build-rhel9-images.yml

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}-${{ github.event_name == 'workflow_dispatch' }}
  cancel-in-progress: true

permissions: read-all

jobs:
  build-rhel9-images:
    runs-on: test-runner-git-109
    timeout-minutes: 240
    strategy:
      fail-fast: false
      matrix:
        tag: ["cuda12.8"]
    steps:
      - name: Checkout PyTorch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Move to custom working directory
        shell: bash
        run: |
          WORK_DIR="/mnt/builds_2/users/gitlab-runner/${GITHUB_RUN_ID}"
          echo "WORK_DIR=${WORK_DIR}" >> $GITHUB_ENV
          mkdir -p "${WORK_DIR}"
          echo "Moving workspace to ${WORK_DIR}"
          rsync -a "${GITHUB_WORKSPACE}/" "${WORK_DIR}/"
          cd "${WORK_DIR}"

      - name: Build and tag RHEL 9 Docker image
        shell: bash
        run: |
          cd "${WORK_DIR}/.ci/docker/rhel9"
          # Build script creates image with temp tag, we need to find it and tag properly
          BEFORE_IMAGES=$(docker images --format '{{.Repository}}:{{.Tag}}' | sort)
          ./build.sh rhel9-builder:${{ matrix.tag }}
          AFTER_IMAGES=$(docker images --format '{{.Repository}}:{{.Tag}}' | sort)
          # Find the newly created image (the temp tag)
          NEW_IMAGE=$(comm -13 <(echo "$BEFORE_IMAGES") <(echo "$AFTER_IMAGES") | grep -v '<none>' | head -1)
          echo "New image created: $NEW_IMAGE"
          # Tag it with the expected names
          docker tag "$NEW_IMAGE" rhel9-builder:${{ matrix.tag }}
          docker tag "$NEW_IMAGE" ci-image:pytorch-rhel-9.6-py3.12-gcc11-${{ matrix.tag }}
          # Also tag without CUDA version suffix for nightly workflow compatibility
          docker tag "$NEW_IMAGE" ci-image:pytorch-rhel-9.6-py3.12-gcc11

      - name: Verify CUDA installation
        if: matrix.tag != 'cpu'
        run: |
          CUDA_VERSION=$(echo "${{ matrix.tag }}" | sed 's/cuda//')
          docker run --rm ci-image:pytorch-rhel-9.6-py3.12-gcc11-${{ matrix.tag }} nvcc --version | grep "release ${CUDA_VERSION}"

      - name: Verify Python version
        run: |
          docker run --rm ci-image:pytorch-rhel-9.6-py3.12-gcc11-${{ matrix.tag }} python --version
          docker run --rm ci-image:pytorch-rhel-9.6-py3.12-gcc11-${{ matrix.tag }} python3.12 --version | grep "Python 3.12"

      - name: Test basic build tools
        run: |
          docker run --rm ci-image:pytorch-rhel-9.6-py3.12-gcc11-${{ matrix.tag }} bash -c "gcc --version && g++ --version && cmake --version"

      - name: Cleanup custom workspace
        if: always()
        shell: bash
        run: |
          echo "Cleaning up custom workspace: ${WORK_DIR}"
          rm -rf "${WORK_DIR}"
          echo "Cleanup complete"
